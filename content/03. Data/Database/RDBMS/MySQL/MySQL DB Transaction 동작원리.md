---
title: MySQL DB Transaction 동작원리
date: 2024-07-15
draft: false
tags:
  - MySQL
  - Database
complete: true
---
## MySQL 트랜잭션
트랜잭션은 **데이터베이스의 상태를 바꾸는 일종의** **작업** **단위**이다.
사실 우리가 MySQL의 입력하는 모든 쿼리 명령어들은 각각 하나의 트랜잭션이라고 할 수 있다.

INSERT, DELETE, UPDATE 등의 SQL 명령문을 통해 데이터를 상태를 바꿀 때마다 내부적으로 자동적으로 Commit을 실행하여 변경된 내역을 데이터베이스의 반영하는 것이다.

![|600](https://i.imgur.com/SMU42Eh.png)


### 트랜잭션 특징
트랜잭션의 특징은 크게 4가지로 구분된다. 


원자성 (Atomicity)
원자성은 **트랜잭션이 데이터베이스에 모두 반영되던가, 아니면 전혀 반영되지 않아야 한다는 것**이다.

트랜잭션은 사람이 설계한 논리적인 작업 단위로서, 일처리는 작업단위 별로 이루어 져야 사람이 다루는데 무리가 없다.  
만약 트랜잭션 단위로 데이터가 처리되지 않는다면, 설계한 사람은 데이터 처리 시스템을 이해하기 힘들 뿐만 아니라, 오작동 했을시 원인을 찾기가 매우 힘들어질것이다.

일관성 (Consistency)
일관성은 **트랜잭션의 작업 처리 결과가 항상 일관성이 있어야 한다는 것**이다.
트랜잭션이 진행되는 동안에 데이터베이스가 변경 되더라도 **업데이트된 데이터베이스로 트랜잭션이 진행되는것이 아니라**, **처음에 트랜잭션을 진행 하기 위해 참조한 데이터베이스로 진행**된다. 
이렇게 함으로써 각 사용자는 일관성 있는 데이터를 볼 수 있는 것이다.

독립성 (Isolation)
독립성은 둘 이상의 트랜잭션이 동시에 실행되고 있을 경우 **어떤 하나의 트랜잭션이라도, 다른 트랜잭션의 연산에 끼어들 수 없다는 점을 가리킨다.
하나의 특정 트랜잭션이 완료될때까지, 다른 트랜잭션이 특정 트랜잭션의 결과를 참조할 수 없다.

영구성 (Durability)
지속성은 트랜잭션이 성공적으로 완료됬을 경우, 결과는 영구적으로 반영되어야 한다는 점이다.

### 트랜잭션 상태
트랜잭션의 개념은 서술한 바와 같이 데이터베이스의 상태를 변환시키는 하나의 논리적 기능을 수행하기 위한 작업의 단위 혹은 데이터베이스 시스템에서 복구 및 병행 수행시 처리되는 작업의 논리적 단위이다.

![|600](https://i.imgur.com/whmRXoL.png)

**1. 활성(Active)** : 트랜잭션이 정상적으로 실행중인 상태를 의미한다.  
  
트랜잭션이 시작되면, 해당 트랜잭션의 상태는 활동(Active)상태가 된다.   
해당 상태는 설계자가 설계한 대로 연산들이 정상적으로 실행중인 상태를 의미한다.  
  
** 작업 성공시,**  
**2-1. 부분 완료(Partially Committed)** : 트랜잭션의 마지막까지 실행되었지만, Commit 연산이 실행되기 직전의 상태  
**2-2. 완료(Committed)** : 트랜잭션이 성공이 종료되어 Commit 연산을 실행한 후의 상태  
  
설계된 트랜잭션대로 명령을 성공적으로 수행하면 그 다음 상태는 부분적 완료(Partially Committed)상태가 된다.   
설계된 작업대로 작업이 성공하였다고 하여 무조건 반영하는 것이 아니라, 설계자의 최종 승인(Commit)이 있을 때 까지 실제 데이터베이스에 작업 내용을 반영하지 않고 기다리고 있는 상태이다.  
설계자가 작업 결과에 대하여 반영을 승인(Commit)한다면 트랜잭션이 성공적으로 종료된다(Committed)  
  
  
**- 작업 실패시,**  
**2-1. 실패(Failed)** : 트랜잭션 실행에 오류가 발생하여 중단된 상태.  
**2-2. 철회(Aborted)** : 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태.  
  
트랜잭션을 수행하는 중간에 모종의 원인으로 인하여 오류가 발생하여 실행이 중단된 상태를 실패(Failed)상태라고 한다.  
이때 트랜잭션이 비정상적으로 종료되었으니, 설계되어있는 트랜잭션 내부의 작업을 다시 수행 이전의 상태로 돌리는 (ROLLBACK) 연산을 수행하면 그 상태를 철회(Aborted)라고 한다.

### 트랜잭션 전역 설정
MySQL에서는 디폴트로 auto commit이 on으로 설정 되어 있다.

명령어를 한 번, 그러니까 세미콜론을 한 번 찍을 때마다 **DB에서 자동으로 commit** 해주는 시스템이다.

```sql
show variables like '%commit%';

autocommit,ON
binlog_group_commit_sync_delay,0
...
...
```

이를, 아예 MySQL 기본 Commit 방식을 바꿀 수 있다.

- 0은 자동 Commit Off
- 1은 자동 Commit On


### 트랜잭션 격리수준
여러 트랜잭션이 동시에 처리될 때, 특정 트랜잭션이 다른 트랜잭션에서 변경하거나 조회하는 데이터를 볼 수 있게 허용할지 여부를 결정하는 것이다. 
트랜잭션의 격리 수준은 격리(고립) 수준이 높은 순서대로 아래가 존재한다. 참고로 아래의 예제들은 모두 자동 커밋(AUTO COMMIT)이 false인 상태에서만 발생한다.
- SERIALIZABLE
- REPEATABLE READ
- READ COMMITTED
- READ UNCOMMITED

아래 명령어로 확인 가능하다:
```sql
select @@global.tx_isolation;

REPEATABLE-READ
```

격리수준 별로 정리해놓은 문서는 여기서 참고하자. https://guaqamole.github.io/posts/mysql-index/#repeatable_read
